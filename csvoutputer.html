<html>
<body>

<input type="file" name="file" id="file">
<div id="result"></div>


<script type="text/javascript">

const divideNumber = 5;

let fileInput = document.getElementById('file');
let fileReader = new FileReader();
var fileName = "";
fileInput.onchange = () => {
  let file = fileInput.files[0];
  fileName = file.name;
  fileReader.readAsText(file,"Shift_JIS");
};

// fileReader.onload = () => console.log(fileReader.result);

fileReader.onload = function () {
  var csvString = fileReader.result;
  var csvArray = csvString.split('\n');
  var csvHeader = csvArray[0].split(",");
  var array = [];

  // カンマ区切りを配列にする
  for(var i=1; i<csvArray.length; i++){
    var tempArray = csvArray[i].split(',');
    csvArray[i] = tempArray;
    array[i] = {};
    for(var j=0; j<csvArray[i].length; j++){
      // array[i][csvHeader[j]] = csvArray[i][j]
      array[i][csvHeader[j]] = csvArray[i][j].replace(/[\"]/g,"");
    }
  }

  // フィルター
  const filteredArray = array.filter(x => x["都道府県(テキスト)"] == "35")

  console.log(filteredArray);

  // 出力用CSV文字列
  var outputCsvStringArray = [];


  // 配列をシャッフル trueだとシャッフルする
  var shuffledArray = shuffleArray(filteredArray,true);

  // 配列を分割 trueだと分割する
  var dividedArray = divideArray(shuffledArray,3,true);

  for(var i=0;i<dividedArray.length;i++){
    outputCsvStringArray.push( createCsvString(dividedArray[i],csvHeader));
  }

  for(var i=0;i<outputCsvStringArray.length;i++){

    var blob = new Blob([outputCsvStringArray[i]], {type: "octet/stream"})
    var url = window.URL.createObjectURL(blob);

    var a = document.createElement("a");
    a.innerHTML = "分割CSV_" + String(i+1);
    a.id = "csv_1"
    a.style = "margin-top: 20px;margin-right: 10px;display: inline-block;padding: 5px 20px;border-radius: 10px;background-color: #3b6ecc;color: #FFF;border-bottom: 5px solid #2c5cb5;";
    a.href = url;
    a.download = "filterd_" + fileName.replace(".csv","_") + String(i+1) + ".csv";
    document.body.appendChild(a);

  }

  /* location.href = URL.createObjectURL(new Blob([outputCsvString], {
    type: "application/octet-stream"
  })) */
  var saveData = (function () {
       var a = document.createElement("a");
       document.body.appendChild(a);
       a.style = "display: none";
       return function (data, fileName) {
           var blob = new Blob([data], {type: "octet/stream"}),
               url = window.URL.createObjectURL(blob);
           a.href = url;
           a.download = fileName;
           a.click();
           window.URL.revokeObjectURL(url);
       };
  }());

  // saveData(outputCsvString, "proceeded_" + fileName + ".csv");
}

// 配列をシャッフル
function shuffleArray(trgtArray,flgBool){
  if(flgBool){
    for(var i = trgtArray.length - 1; i > 0; i--){
      var r = Math.floor(Math.random() * (i + 1));
      var tmp = trgtArray[i];
      trgtArray[i] = trgtArray[r];
      trgtArray[r] = tmp;
    }
  }
  return trgtArray;
}

// CSV文字列を作る
function createCsvString(trgtArray,trgtHeader){
  var tmpOutputCsvString = "";
  //ヘッダー生成
  for( var j=0; j<trgtHeader.length;j++ ){
    tmpOutputCsvString += trgtHeader[j];
    if( j == trgtHeader.length-1){
      tmpOutputCsvString += "\n";
    }else{
      tmpOutputCsvString += ",";
    }
  }

  //データ生成
  for(var i=0; i<trgtArray.length;i++){
    for( var j=0; j<trgtHeader.length;j++ ){
      tmpOutputCsvString += trgtArray[i][trgtHeader[j]];
      if( j == trgtHeader.length-1){
        tmpOutputCsvString += "\n";
      }else{
        tmpOutputCsvString += ",";
      }
    }
  }
  return tmpOutputCsvString;
}

// 配列分割
function divideArray(trgtArray,divideNum,flgBool){
    var dividedArray = [];
    if(flgBool){
      // 配列分割個数
      var dividedArrayNum = parseInt(trgtArray.length / divideNum) ;

      // 配列分割あまり
      var dividedRestNum = (trgtArray.length % divideNum) ;

      for(var i=0;i<divideNum;i++){
        if(i == 0){
          // divideArray[i] = trgtArray.slice(0,divideNum); 
          dividedArray.push(trgtArray.slice(0,dividedArrayNum));
        }else if( i == divideNum-1){
          dividedArray.push(trgtArray.slice(i*dividedArrayNum , ((i+1) * dividedArrayNum) + dividedRestNum));
        }else{
          // divideArray[i] = trgtArray.slice(i*divideNum,(i+1) * divideNum); 
          dividedArray.push(trgtArray.slice(i*dividedArrayNum,(i+1) * dividedArrayNum));
        }
      }

      trgtArray = dividedArray;
    }
    return trgtArray;
}

</script>

</body>
</html>